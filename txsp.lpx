#!name = è…¾è®¯è§†é¢‘
#!desc = ä¸è´Ÿå¥½æ—¶å…‰ [ä¸è´Ÿå¥½å¹¿å‘Š]
#!openUrl = https://apps.apple.com/app/id458318329
#!author = RuCu6[https://github.com/RuCu6]
#!tag = å»å¹¿å‘Š
#!system = 
#!system_version = 
#!loon_version = 3.3.4(898)
#!homepage = https://github.com/sooyaaabo/Loon/blob/main/README.md
#!icon = https://raw.githubusercontent.com/sooyaaabo/Loon/main/Icon/App-Icon/TencentVideo.png
#!date = 2025-09-18 12:00

# https://raw.githubusercontent.com/RuCu6/QuanX/main/Rewrites/Cube/cnftp.snippet
# https://raw.githubusercontent.com/fmz200/wool_scripts/main/Loon/rule/TencentVideo.list


VIP = switch, false, tag = [å¯ç”¨]ä¼šå‘˜, desc = å…³é—­å¼€å…³å°†ä¸å¯¹æ­¤é€‰é¡¹ç”Ÿæ•ˆ
Cookie = input, "", tag = Cookie, desc = å¿…å¡«
MConfigInfo = input, "{"client":{"version":1830912,"appver":"9.1.70"},"device":{"os":"iOS","deviceModel":"iPhone 12"}}", tag = MConfigInfo ,desc = é€‰å¡«
UserAgent = input, "Mozilla/5.0 (iPhone; CPU iPhone OS 15_3_1 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Mobile/15E148 TencentVideo/8.0.30", tag = UserAgent, desc = é€‰å¡«


[Rule]
AND, ((IP-CIDR, 0.0.0.0/0, no-resolve), (USER-AGENT, "live4iphoneRel*")), REJECT-DROP

DOMAIN, adsmind.gdtimg.com, REJECT
DOMAIN, info4.video.qq.com, REJECT
DOMAIN, info6.video.qq.com, REJECT
DOMAIN, ios.video.mpush.qq.com, REJECT
DOMAIN, otheve.beacon.qq.com, REJECT
DOMAIN, pgdt.gtimg.cn, REJECT
DOMAIN, tpns.qq.com, REJECT
DOMAIN, vv6.video.qq.com, REJECT
DOMAIN-SUFFIX, gdt.qq.com, REJECT
DOMAIN-SUFFIX, l.qq.com, REJECT
DOMAIN-KEYWORD, trace.qq.com, REJECT
DOMAIN-KEYWORD, trace.video.qq.com, REJECT
IP-CIDR, 47.110.187.87/32, REJECT, no-resolve
URL-REGEX, "^http:\/\/[\d\.:]*\/?(defaultts\.tc|vmind\.qqvideo\.tc|finderpdd\.video)\.qq\.com\/\w+", REJECT
URL-REGEX, "^http:\/\/apd-vlive\.apdcdn\.tc\.qq\.com\/vmind\.qqvideo\.tc\.qq\.com\/\w+", REJECT
URL-REGEX, "^http:\/\/apd-\w+\.v\.smtcdns\.com\/(defaultts|omts|vmind\.qqvideo)\.tc\.qq\.com\/\w+", REJECT

DOMAIN, ugchsy.gtimg.com, REJECT
DOMAIN, rmonitor.qq.com, REJECT
DOMAIN, activity.video.qq.com, REJECT
DOMAIN, iacc.qq.com, REJECT
DOMAIN, tux.qq.com, REJECT
DOMAIN, aegis.qq.com, REJECT
DOMAIN, rdelivery.qq.com, REJECT
DOMAIN-SUFFIX, static-res.qq.com, REJECT
DOMAIN-SUFFIX, gdtimg.com, REJECT
DOMAIN-SUFFIX, l.qq.com, REJECT
DOMAIN-SUFFIX, gdt.qq.com, REJECT
DOMAIN-SUFFIX, video.mpush.qq.com, REJECT
DOMAIN-SUFFIX, api.poll.video.qq.com, REJECT
DOMAIN-SUFFIX, tpns.tencent.com, REJECT
DOMAIN-SUFFIX, omgmta.qq.com, REJECT
DOMAIN-SUFFIX, omgmta1.qq.com, REJECT
DOMAIN-KEYWORD, track.qq.com, REJECT
DOMAIN-KEYWORD, trace.qq.com, REJECT
DOMAIN-KEYWORD, pgdt.gtimg.c, REJECT
DOMAIN-KEYWORD, trace.video.qq.com, REJECT
DOMAIN-KEYWORD, 1258344696.file.myqcloud.com, REJECT
IP-CIDR, 183.201.213.194/32, REJECT, no-resolve
IP-CIDR, 120.222.144.64/32, REJECT, no-resolve
IP-CIDR, 111.6.166.107/32, REJECT, no-resolve

[Rewrite]
# ^http:\/\/[\d\.:]*\/?(defaultts\.tc|vmind\.qqvideo\.tc|finderpdd\.video)\.qq\.com\/\w+ reject
# ^http:\/\/apd-vlive\.apdcdn\.tc\.qq\.com\/vmind\.qqvideo\.tc\.qq\.com\/\w+ reject
# ^http:\/\/apd-\w+\.v\.smtcdns\.com\/(defaultts|omts|vmind\.qqvideo)\.tc\.qq\.com\/\w+ reject
^https?:\/\/vv\.video\.qq\.com\/(diff|get)vmind reject-dict
^https?:\/\/vv\.video\.qq\.com\/getvinfo request-body-replace-regex &sppreviewtype=\d(.*)&spsrt=\d &sppreviewtype=0$1&spsrt=0

[Script]
# http-request ^https?:\/\/vv\.video\.qq\.com\/getvinfo script-path = https://raw.githubusercontent.com/sooyaaabo/Loon/main/Script/CommonScript/replace-body.js, requires-body = true, tag = [è…¾è®¯è§†é¢‘]ç§»é™¤å¹¿å‘Š, argument="&sppreviewtype=\d(.*)&spsrt=\d->&sppreviewtype=0$1&spsrt=0"

[MitM]
hostname = vv.video.qq.com


const url = $request.url;
const header = $request.headers;
const isQQVideo = url.includes("video.qq.com");

if (isQQVideo) {
    // å‡è®¾æœ‰ä»¥ä¸‹å‚æ•°ä»ç”¨æˆ·è¾“å…¥ï¼ˆç±»ä¼¼ç½‘æ˜“äº‘éŸ³ä¹çš„å¤„ç†æ–¹å¼ï¼‰
    const cookie = $argument?.Cookie;
    const userAgent = $argument?.UserAgent;

    // æ£€æŸ¥å¿…è¦çš„å‚æ•°æ˜¯å¦å­˜åœ¨
    if (!cookie || !userAgent) {
        console.log("å‚æ•°ç¼ºå¤±ä¿¡æ¯ï¼š");
        if (!cookie) console.log("âŒ Cookie å‚æ•°ç¼ºå¤±");
        if (!userAgent) console.log("âŒ UserAgent å‚æ•°ç¼ºå¤±");

        // æç¤ºç”¨æˆ·ç¼ºå¤±å‚æ•°
        $notification.post(
            "è…¾è®¯è§†é¢‘é‡åˆ°é—®é¢˜",
            "å‚æ•°ç¼ºå¤±",
            "è¯·åœ¨æ’ä»¶å†…å¡«å…¥ä¼šå‘˜æ•°æ®"
        );
        $done({});
    } else {
        // ä¿®æ”¹è¯·æ±‚å¤´ä¸­çš„å­—æ®µ
        header["cookie"] = cookie;
        header["user-agent"] = userAgent;

        // è¾“å‡ºæ—¥å¿—ä¿¡æ¯
        console.log("âœ… è…¾è®¯è§†é¢‘ä¼šå‘˜å·²è§£é” ğŸ‰");

        // è¿”å›ä¿®æ”¹åçš„è¯·æ±‚å¤´
        $done({ headers: header });
    }
} else {
    // å¦‚æœè¯·æ±‚ä¸æ˜¯æ¥è‡ª video.qq.comï¼Œç›´æ¥ç»“æŸ
    $done({});
}
